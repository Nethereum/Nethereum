@using MudBlazor
@using Nethereum.Wallet.UI.Components.SendTransaction
@using Nethereum.Wallet.UI.Components.SendTransaction.Components
@using Nethereum.Wallet.UI.Components.Core.Localization
@using Nethereum.Wallet.UI.Components.Blazor.Shared
@using Nethereum.Wallet.Services.Tokens.Models
@using static Nethereum.Wallet.UI.Components.Blazor.Shared.WalletTextField
@using static Nethereum.Wallet.UI.Components.SendTransaction.SendNativeTokenLocalizer
@inject IComponentLocalizer<SendNativeTokenViewModel> Localizer
@inject IWalletLocalizationService LocalizationService
@implements IDisposable

@if (ViewModel.AvailableTokens.Count > 1)
{
    <WalletFormSection Title="@Localizer.GetString(Keys.SelectToken)">
        <MudSelect T="AccountToken"
                   Value="@ViewModel.SelectedToken"
                   ValueChanged="@OnTokenSelected"
                   Label="@Localizer.GetString(Keys.Token)"
                   Variant="Variant.Outlined"
                   Dense="true"
                   Disabled="@ViewModel.IsLoadingTokens">
            @foreach (var token in ViewModel.AvailableTokens)
            {
                <MudSelectItem Value="@token">
                    <div class="d-flex align-center gap-2">
                        @if (!string.IsNullOrEmpty(token.LogoURI))
                        {
                            <MudAvatar Size="Size.Small" Image="@token.LogoURI" />
                        }
                        else
                        {
                            <MudAvatar Size="Size.Small" Color="Color.Primary">@token.Symbol[0]</MudAvatar>
                        }
                        <div>
                            <MudText Typo="Typo.body2" Class="font-weight-medium">@token.Symbol</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @FormatBalance(token.Balance, token.Decimals) @token.Symbol
                            </MudText>
                        </div>
                    </div>
                </MudSelectItem>
            }
        </MudSelect>
        @if (ViewModel.IsLoadingTokens)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Size="Size.Small" Class="mt-1" />
        }
    </WalletFormSection>
}

<WalletFormSection Title="@Localizer.GetString(Keys.RecipientSection)">
    <WalletTextField @bind-Value="ViewModel.NativeTransfer.RecipientAddress"
                     LabelKey="@Keys.RecipientAddress"
                     PlaceholderKey="@Keys.RecipientAddressPlaceholder"
                     Localizer="@Localizer"
                     FieldType="WalletTextFieldType.Address"
                     Required="true"
                     Error="@ViewModel.NativeTransfer.HasFieldErrors(nameof(ViewModel.NativeTransfer.RecipientAddress))"
                     ErrorText="@ViewModel.NativeTransfer.GetFieldError(nameof(ViewModel.NativeTransfer.RecipientAddress))"
                     IsMonospace="true" />
</WalletFormSection>

<WalletFormSection>
    <WalletTextField @bind-Value="ViewModel.NativeTransfer.Amount"
                     LabelKey="@Keys.Amount"
                     PlaceholderKey="@Keys.AmountPlaceholder"
                     Localizer="@Localizer"
                     Suffix="@ViewModel.NativeTransfer.TokenSymbol"
                     Required="true"
                     Error="@ViewModel.NativeTransfer.HasFieldErrors(nameof(ViewModel.NativeTransfer.Amount))"
                     ErrorText="@ViewModel.NativeTransfer.GetFieldError(nameof(ViewModel.NativeTransfer.Amount))" />
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mt-2">
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @Localizer.GetString(Keys.AvailableBalance): @ViewModel.NativeTransfer.FormattedAvailableBalance @ViewModel.NativeTransfer.TokenSymbol
        </MudText>
        <MudButton Size="MudBlazor.Size.Small" 
                   Variant="Variant.Text" 
                   Color="Color.Primary"
                   OnClick="@(() => ViewModel.NativeTransfer.SetMaxAmount())">
            @Localizer.GetString(Keys.MaxButton)
        </MudButton>
    </MudStack>
</WalletFormSection>

@code {
    [Parameter] public SendNativeTokenViewModel ViewModel { get; set; } = null!;

    protected override void OnInitialized()
    {
        LocalizationService.LanguageChanged += OnLanguageChanged;

        if (ViewModel?.NativeTransfer != null)
        {
            ViewModel.NativeTransfer.PropertyChanged += OnViewModelPropertyChanged;
            ViewModel.PropertyChanged += OnViewModelPropertyChanged;
        }
    }

    private void OnLanguageChanged(string languageCode)
    {
        InvokeAsync(StateHasChanged);
    }

    private void OnViewModelPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName == nameof(ViewModel.NativeTransfer.IsValid) ||
            e.PropertyName == nameof(ViewModel.SelectedToken) ||
            e.PropertyName == nameof(ViewModel.AvailableTokens) ||
            e.PropertyName == nameof(ViewModel.IsLoadingTokens) ||
            e.PropertyName?.EndsWith("Error") == true ||
            e.PropertyName == "HasErrors")
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnTokenSelected(AccountToken token)
    {
        if (token != null)
        {
            await ViewModel.SelectTokenCommand.ExecuteAsync(token);
            StateHasChanged();
        }
    }

    private string FormatBalance(System.Numerics.BigInteger balance, int decimals)
    {
        if (balance == System.Numerics.BigInteger.Zero)
            return "0";

        var tokenValue = Nethereum.Util.UnitConversion.Convert.FromWei(balance, decimals);

        if (tokenValue >= 1000)
            return tokenValue.ToString("N2");
        else if (tokenValue >= 1)
            return tokenValue.ToString("F4").TrimEnd('0').TrimEnd('.');
        else if (tokenValue >= 0.001m)
            return tokenValue.ToString("F6").TrimEnd('0').TrimEnd('.');
        else
            return tokenValue.ToString("F8").TrimEnd('0').TrimEnd('.');
    }

    public void Dispose()
    {
        LocalizationService.LanguageChanged -= OnLanguageChanged;

        if (ViewModel?.NativeTransfer != null)
        {
            ViewModel.NativeTransfer.PropertyChanged -= OnViewModelPropertyChanged;
            ViewModel.PropertyChanged -= OnViewModelPropertyChanged;
        }
    }
}